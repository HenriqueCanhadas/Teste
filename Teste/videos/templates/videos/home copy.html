<!DOCTYPE html>
<html>
<head>
    <title>Baixar Vídeo</title>
</head>
<body>
    <h1>Baixar vídeo do YouTube</h1>

    <form id="downloadForm">
        {% csrf_token %}
        <input type="text" id="video_url" name="video_url" placeholder="Cole o link do vídeo" required>
        <button type="submit">Baixar</button>
    </form>

    <pre id="terminal" style="background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; display: none; font-family: monospace;"></pre>

    <div id="downloadLink"></div>

    <script>
    document.getElementById('downloadForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const url = document.getElementById('video_url').value;
        const terminal = document.getElementById('terminal');
        const linkDiv = document.getElementById('downloadLink');
        terminal.style.display = 'block';
        terminal.innerHTML = '';
        linkDiv.innerHTML = '';
    
        const eventSource = new EventSource(`/videos/stream-download/?video_url=${encodeURIComponent(url)}`);
    
        eventSource.onmessage = function(e) {
            let output = e.data;
        
            if (output.startsWith("DONE::")) {
                const filename = output.split("::")[1];
                terminal.innerHTML += `<div style="color: lightgreen;">✅ Download finalizado!</div>`;
                linkDiv.innerHTML = `<a href="/videos/download/${filename}"><button>Download do vídeo</button></a>`;
                eventSource.close();
            } else if (output.startsWith("ERRO::")) {
                const errorMsg = output.split("::")[1];
                terminal.innerHTML += `<div style="color: red;">❌ ERRO: ${errorMsg}</div>`;
                eventSource.close();
            } else {
                // Aplica cor condicional
                let lineColor = "#0f0"; // padrão verde
            
                if (output.toLowerCase().includes("erro") || output.toLowerCase().includes("error")) {
                    lineColor = "red";
                } else if (output.toLowerCase().includes("resolução detectada") || output.toLowerCase().includes("baixando")) {
                    lineColor = "lightgreen";
                }
            
                terminal.innerHTML += `<div style="color: ${lineColor}; white-space: pre-wrap;">${output}</div>`;
            }
        
            terminal.scrollTop = terminal.scrollHeight;
        };
    });
    </script>
</body>
</html>
